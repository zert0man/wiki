# Лабораторная работа 2. PHP Silex

## Цели работы
- Познакомиться с языком PHP.
- Изучить реализацию паттерна MVC в микрофреймворке Silex.
- Изучить принципы шаблонизации на примере Twig.

## Краткие теоретические сведения

### Принцип работы HTTP-сервера

HTTP-сервер занимается тем, что получает http-запросы (request) и отправляет на них ответы (response). Запросы могут быть отправлены несколькими методами. Два основных - это POST и GET.

**GET** используется для запроса содержимого указанного ресурса. Это самый обычный http-запрос. С помощью метода GET можно также начать какой-либо процесс. В этом случае в тело ответного сообщения следует включить информацию о ходе выполнения процесса.

Клиент может передавать параметры выполнения запроса в URI целевого ресурса после символа «?»:
```
 /path/resource?param1=value1&param2=value2 
```

**POST** применяется для передачи пользовательских данных заданному ресурсу. Например, в блогах посетители обычно могут вводить свои комментарии к записям в HTML-форму, после чего они передаются серверу методом POST и он помещает их на страницу. При этом передаваемые данные (в примере с блогами — текст комментария) включаются в тело запроса. Аналогично с помощью метода POST обычно загружаются файлы на сервер.

Что конкретно ответить на запрос, сервер определяет по URL, который прописан в запросе. Это может быть как файл, так и результат работы какой-нибудь программы, например, php-скрипта.

Следует различать пути для сайта (URL) и пути в операционной системе. Через браузер пользователь не может попасть за пределы папки `DOCUMENT_ROOT`. В частности, это означает, что в html-коде и других фронтенд-скриптах нельзя получить доступ к содержимому за пределами этой папки. Однако серверные скрипты работают в файловой системе сервера, и на них это ограничение не распространяется.

### Silex

**Silex** - MVC-микрофреймворк для разработки веб-приложений на языке PHP.

В принципе, для реализации модели и представления могут быть подключены разные библиотеки. В стандартный fat-пакет Silex входит DBAL Doctrine для реализации модели и шаблонизатор Twig для реализации представления.  

Рассмотрим пример.
```
require_once __DIR__.'/../vendor/autoload.php'; 

$app = new Silex\Application(); 

$app->get('/hello/{name}', function($name) use($app) { 
    return 'Hello '.$app->escape($name); 
}); 

$app->run(); 
```
Это минимально приложение на Silex, которое обрабатывает get-запросы по одному адресу: `'/hello/{name}'`. 
Такие шаблоны называются маршрутами (routes). `{name}` - это параметр маршрута. Если URL http-запроса соответствует этому шаблону, то будет вызвана соответствующая анонимная функция. Функция контроллера, формирующая http-ответ для определенного маршрута, называется действием (action).

В приложении на Silex сначала создается объект ( в нашем примере - `$app`), который представляет собой контейнер компонентов. Далее в него добавляются необходимые компоненты и маршруты с действиями в порядке обработки (то есть если URL соответствует нескольким шаблонам, то будет выполнено то действие, которое встретилось раньше). После этого выполняется метод `$app->run()`, который выполняет поиск подходящего маршрута и выполнение соответствующего ему действия.

### Twig
**Twig** - это шаблонизатор для PHP. Шаблонизатор предназначен для того, чтобы вставлять данные, полученные из контроллера в сверстанные html-макеты, вроде тех, которые делали в лабораторной работе 1. В принципе, PHP можно использовать для вставок и без шаблонизатора, но код получается громоздким, плохо читаемым, небезопасным. Twig предоставляет простой и лаконичный язык для вставки данных в html. Кроме того, шаблоны Twig очень легко вставлять друг в друга. Это делается с помощью наследования. Например, рассмотрим создадим простой базовый шаблон и сохраним его в файле `base.twig`:
```
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>{% block title %}{% endblock %}</title>
</head>
<body>
<div class="container">
{% block content %}{% endblock %}
</div>
</body>
</html>
```
В этом шаблоне два пустых блока: `title` для вставки заголовка страницы и `content` для генерации содержимого. Создадим шаблон-наследник от этого шаблона:
```
{% extends "BASE.twig" %}
{% block content %}
<h1>{{ object.data }}</h1>
{% endblock %}
```
Краткий набор примеров можно найти [тут](Cheat-list-Twig). Полную документацию смотрите [на официальном сайте](http://twig.sensiolabs.org/documentation).

### Doctrine

## Порядок выполнения
[Репозиторий с примером лабораторной работы ](https://github.com/mesdt/hw1)
### Установка и настройка 
1. Скачать Silex и распаковать в папку, общую с vagrant-коробкой. 
1. Настроить виртуальный хост `1.mesdt` на сервере nginx. Проверить работоспособность. Сконфигурируйте перенаправление на `index.php`, используйте настройки для вашего веб-сервера ([http://silex.sensiolabs.org/doc/web_servers.html](http://silex.sensiolabs.org/doc/web_servers.html)).
- Для **nginx**. На виртуальной машине создать файл `/etc/nginx/sites-available/1.mesdt` по аналогии с файлом `0.mesdt`. Добавить конфигурацию из документации.
- Для **apache**. Настроить виртуальный хост и создать в папке `web` файл `.htaccess` в соответствии с документацией.
- Можно также запустить встроенный веб-сервер интерпретатора php. Выполните на машине, на которой установлен php (то есть, в консоли виртуальной машины, или в консоли вашего компьютера для пользователей XAMPP):

 ```
 php -S localhost:8000
 ```
1. Вся логика веб-приложения будет реализована в файле `/web/index.php`. Однако, кроме собственно html-страниц наш сервер должен отдавать браузеру css, js-скрипты и картинки. Это просто файлы, которые лежат в директории сайта. Все эти файлы называются статическими ресурсами сайта. Для того, чтобы браузер имел доступ к ним, добавим в начало `index.php` соответствующую проверку. Если пришедший от пользователя запрос содержит в url имя файла, то скрипт передает управление веб-серверу.
   
```
// Для php -S host:port -t web web/index.php, чтобы статика отдавалась
if (php_sapi_name() === 'cli-server' && is_file(__DIR__ . preg_replace('/(\?.*)$/', '', $_SERVER['REQUEST_URI']))) {
return false;
}
```

```
use Silex\Application;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
```

### Подключение к базе данных
1. Подключите пространства имен для работы с Doctrine 
 
 ```
 use Doctrine\DBAL\Connection;
 use Silex\Provider\DoctrineServiceProvider;
 ```
2. Зарегистрируйте компонент в контейнере.
 
 ```
 $sapp->register(new DoctrineServiceProvider(),
 ['db.options' => ['driver' => 'pdo_mysql', 'dbname' => 'hw1', 'charset' => 'utf8']]);
 ```
3. Используйте функции DBAL для получения данных
 
 ```
 $conn = $app['db'];
 $students = $conn->fetchAll('select * from students');
 ```

### Подключение шаблонов
1. Для подключения сервиса Twig используется следующее пространство имен:
  
 ```
 use Silex\Provider\TwigServiceProvider;
 ```

2. Создайте папку для шаблонов рядом с папками `vendor` и `web`. Подключаем в контейнер:

 ```
 $sapp->register(new TwigServiceProvider(),['twig.path' => __DIR__ . '/../views']) 
 ```
3. Создайте базовый шаблон из макета, который вы сверстали на первой лабораторной.
4. Создайте шаблоны для списка объектов и для одного объекта.
5. Подключите их в соответствующих действиях.
```
 return $app['twig']->render('students.twig', ['students' => $students]);
```

## Порядок защиты работы
При защите лабораторной работы необходимо предоставить работающее web-приложение, реализованное на фреймворке Silex и запущенное на web-сервере. Приложение должно выводить список объектов из базы данных.
Отчет должен содержать титульный лист, задание, код контроллера, код шаблонов Twig.

## Ссылки на документацию
- Документация по PHP [http://php.net/docs.php](http://php.net/docs.php)
- Документация по PHP на русском [http://php.su](http://php.su)
- PHP Silex Docs [http://silex.sensiolabs.org/documentation](http://silex.sensiolabs.org/documentation)
- Документация по Twig[http://twig.sensiolabs.org/](http://twig.sensiolabs.org/)
- Документация по Doctrine [http://www.doctrine-project.org/](http://www.doctrine-project.org/)
- Конфигурирование сервера для сайта под Silex [http://silex.sensiolabs.org/doc/web_servers.html](http://silex.sensiolabs.org/doc/web_servers.html)