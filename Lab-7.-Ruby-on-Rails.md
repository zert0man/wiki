#Лабораторная работа 7. Ruby on Rails

##Цели и задачи

**Цель работы:** познакомиться с фреймворком Ruby on Rails.

**Задачи работы: **
- Изучить структуру Ruby on Rails.
- Создать простейшее CRUD-приложение с использованием базы данных SQLite.
- При защите лабораторной необходимо разбираться в файлах, оказавшихся в папке `app`, а также в конфигурации базы данных и маршрутов. Кроме того, надо ориентироваться внутри файлов контроллеров, моделей, видов и миграций.	

**Дополнительное задание:**
- Для повышения оценки вы можете подключить MySQL вместо SQLite. 
- Любая функциональность, больше, чем один модуль простейшего CRUD, будет плюсом.

В русскоязычном сообществе имеется качественный перевод [Getting Started with Rails](http://rusrails.ru/getting-started-with-rails). Этого руководства достаточно, чтобы создать CRUD. Необходимый минимум для данной лабораторной - это список объектов из базы и страница для подробного описания объекта. Далее в разделе "Порядок выполнения" приведен краткий алгоритм действий. За более подробной инструкцией обращайтесь к руководству.

##Краткие теоретические сведения

Краткое описание особенностей и синтаксиса Ruby смотрите в **Приложении Г**. Язык отличается простотой и лаконичностью.

Ruby on Rails - классический MVC-фреймворк для языка Ruby.

Модели Ruby on Rails реализованы на основе ORM и Active Record. Схема базы в Ruby on Rails хранится в виде миграций. **Миграции** - это особенность Active Record, позволяющая наращивать схему вашей базы данных со временем. Вместо того, чтобы записывать изменения схемы на чистом SQL, миграции позволяют использовать специальный, очень простой язык Ruby DSL для описания изменений в ваших таблицах.

Сервер Ruby использует свою собственную систему команд Rake. Rake - инструмент для автоматизации сборки программного кода, написанный на Ruby, подобен таким инструментам как make (установщик из исходных кодов для Linux и Unix), Ant (для Java). После установки команды rake будут доступны из консоли операционной системы.

Для получения справки вызывайте любую команду rake с ключом `-h`, например, как в команде создания приложения:
```
	rails new -h
```
	Вокруг Rails сложилась большая экосистема плагинов, - подключаемых гемов (gem). Начиная с третьей версии Rails наблюдается тенденция вынесения части функционала в отдельные гемы, отчасти из-за их более быстрого развития, чем сам Rails, отчасти для облегчения фреймворка.

Некоторые гемы: 
- Devise (для аутентификации), CanCan (для авторизации),
- Inherited Resources (для упрощения создания контроллеров с стандартным CRUD-кодом),
- friendly_id (позволяет создавать человеко-понятные веб-адреса), 
- Active Admin (для создания панелей администрирования) и др.

Для установки гема используется команда
	\begin{verbatim}
	gem install имя_гема
	\end{verbatim}
	
\subsubsection{Структура приложения}
\begin{table}[h]
	\centering
		\begin{tabular}{|p{3cm}|p{10cm}|}
		\hline
\texttt{Файл/Папка} &	\textbf{Назначение} \\ \hline
\texttt{app/} &	Содержит контроллеры, модели, представления, хелперы, рассыльщики и ресурсы вашего приложения. \\ \hline
\texttt{bin/} &	Содержит Rails-скрипты, которые стартуют ваше приложение, может содержать другие скрипты для развертывания или запуска. \\ \hline
\texttt{config/} &	Конфигурации правил, маршрутов, базы данных приложения, и т.д.  \\ \hline
\texttt{db/} &	Содержит текущую схему вашей базы данных, а также миграции базы данных. \\ \hline
\texttt{Gemfile} \texttt{Gemfile.lock} &	Эти файлы позволяют указать, какие зависимости от гемов нужны для вашего приложения на Rails (аналог \texttt{composer.json} в php-проектах). Эти файлы используются гемом Bundler. \\ \hline
\texttt{lib/} &	Внешние модули приложения.\\ \hline
\texttt{log/} & 	Файлы логов приложения.\\ \hline
\texttt{public/} &	Точка входа. Единственная папка, которая доступна извне как есть. Содержит статичные файлы и скомпилированные ресурсы.\\ \hline
\texttt{Rakefile} & Этот файл содержит набор команд, которые могут быть запущены в командной строке.\\ \hline
\texttt{test/} &	Юнит-тесты и прочий аппарат тестирования. \\ \hline
\texttt{tmp/} &	Временные файлы (файлы кэша, pid и сессии).\\ \hline
\texttt{vendor/} &	Место для кода внешних разработчиков. В типичном приложении на Rails, включает Ruby Gems и исходный код Rails.\\ \hline
		\end{tabular}
\end{table}	
%----------------------------------------------------------------------------------
\section{Порядок выполнения}

\subsection{Установка инструментов}
\begin{enumerate}
	\item Скачайте и распакуйте RailsInstaller. Разрешите установщику прописать папку, куда вы все поставили. в переменную \texttt{PATH}, 
	\item Запустите командную строку в режиме администратора. А еще лучше, создайте bat-файл, который будете потом запускать, сразу с переходом в нужную папку:
	\begin{verbatim}
	cd c:\WORK\projects\RubyExmp\
  cmd.exe
	\end{verbatim}
	\item Запустите команду 
	\begin{verbatim}
		gem install rails
	\end{verbatim}
	\item Все готово к созданию приложения!
\end{enumerate}

\subsection{Создание приложения}


\subsubsection{Порядок выполнения}
 Далее приведен краткий порядок действий. Подробное описание смотрите в руководстве.
\begin{enumerate}
	\item Создайте приложение Ruby on Rails. Это делается командой (параметр \texttt{cups} -- это имя каталога, в котором будет создано приложение).
	\begin{verbatim}
		rails new cups
	\end{verbatim}
	Для создания приложения с MySQL используйте команду:
	\begin{verbatim}
		rails new cups -d mysql
	\end{verbatim}
	или внесите изменения позже в файл конфигурации базы и файл \texttt{Gemfile}. Для работы с MySQL необходимо установить соответствующий гем. Инструкцию по установке в Windows см. ниже.
	\item Посмотрите структуру приложения. Найдите файл \texttt{database.yml} (конфигурация базы данных) и \texttt{routes.rb} (конфигурация маршрутов, содержит много примеров).
	\item Запустите сервер командой 
	\begin{verbatim}
		rails server
	\end{verbatim}
	По умолчанию сервер Ruby занимает порт 3000. Зайдите на \texttt{localhost:3000} и порадуйтесь, что сайт заработал. Все последующие изменения можно производить при включеном сервере, они будут подхватываться <<на лету>>. Вам придется запустить еще одно окно консоли, чтобы не останавливать сервер.
	\item Сгенерируйте <<строительные леса>> для CRUD. Чтобы уменьшить количество кода, используйте правила именования (см. руководство).
	\begin{verbatim}
	rails generate scaffold cup name:text height:integer 
	d:integer has_plate:boolean
	\end{verbatim}
	При выполнении команды создается файл модели, файл миграции, контроллеры, представления, ресурсы и все необходимое для функционирования CRUD. Изучите их структуру.	
	\item Откройте созданный файл контроллера с помощью текстового редактора и изучите его содержимое.
	\item Зайдите в файл конфигурации маршрутов, раскомментируйте и исправьте строчку с маршрутом до главной страницы.
	\begin{verbatim}
			root 'cups#index'
	\end{verbatim}	
	\item Если вы работаете с MySQL, самое время залезть в файл конфигурации базы и изменить настройки. Запустите миграцию. При этом на сервере создастся база в соответствии с вашим описанием. Обратите внимание, что если на сервере что-то было, оно будет приведено в соответствие со схемой, описанной в миграции. Кроме того, Ruby on Rails сам добавит к вашим полям \texttt{id}, \texttt{created\_at} и \texttt{updated\_at}, и будет сам их заполнять.	
	\begin{verbatim}
	rake db:migrate
	\end{verbatim}
	Если вы промазали с полями таблицы, то их можно поменять в файле миграции, который находится в папке \texttt{db/}, и снова выполнить эту команду.
	\item Обновите страницу сайта и проверьте работоспособность. Заметьте, до этого момента вам не мешало незнание Ruby.
	\item Легким мановением руки добавьте верстку из первой лабораторной в представления и готовьтесь к защите лабы.
\end{enumerate}

\subsection{Установка гема MyQSL}
По какой-то неведомой причине Ruby не видит MyQSL под Windows. Пусть вы установили Ruby в папку <<\texttt{c:/WORK/projects/RailsInstaller}>>
\begin{enumerate}
	\item Скачайте и распакуйте в папку с Ruby папку \\* \texttt{c:/WORK/projects/RailsInstaller/mysql} коннектор для MySQL, соответствующий вашей операционной системе и с суффиксом <<\texttt{noinstall}>>.
	\item Найдите в папке \texttt{mysql/lib} файл \texttt{libmysql.dll} и скопируйте его в папку <<\texttt{c:/WORK/projects/RailsInstaller/Ruby1.9.3/bin}>>. Это необходимо, чтобы ruby видел его во время работы.
	\item Запустите установку гема для mysql с указанием пути до вашего коннектора:
	\begin{verbatim}
 
		\end{verbatim}
	\item После этих операций можно выполнить настройку приложения на MySQL. Не забудьте запустить сервер этой СУБД! 	
\end{enumerate}
%----------------------------------------------------------------------------------
\section{Ссылки на скачивание инструментов}
\begin{itemize}
	\item Установщик сервера Ruby on Rails \\* \texttt{https://github.com/railsinstaller/railsinstaller-windows/releases}
	\item Коннектор для MySQL для компиляции гема mysql2 \\* \texttt{http://dev.mysql.com/downloads/connector/c/6.0.html}
	\item IDE Aptana RadRails 2.0.5 \\* \texttt{http://www.aptana.com/products/radrails/download}
\end{itemize}

\section{Дополнительная литература}
\begin{itemize}
	\item Документация по фреймворку на русском \texttt{http://rusrails.ru/}
	\item Getting Started with Rails на русском	\\* \texttt{http://rusrails.ru/getting-started-with-rails}
	\item Getting Started with Rails (пример создания блога) \\* \texttt{http://guides.rubyonrails.org/getting\_started.html}
	\item Большой список гемов \texttt{https://rubygems.org}
	\item Русскоязычный Викиучебник по Ruby \\*	\texttt{http://ru.wikibooks.org/wiki/Ruby}
\end{itemize}