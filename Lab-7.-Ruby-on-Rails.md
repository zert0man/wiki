#Лабораторная работа 7. Ruby on Rails

##Цели и задачи

** Цель работы:** познакомиться с фреймворком Ruby on Rails.

** Задачи работы: **
- Изучить структуру Ruby on Rails.
- Создать простейшее CRUD-приложение с использованием базы данных MySQL.
- При защите лабораторной необходимо разбираться в файлах, оказавшихся в папке `app`, а также в конфигурации базы данных и маршрутов. Кроме того, надо ориентироваться внутри файлов контроллеров, моделей, видов и миграций.	

Работа со связанными таблицами не обязательна, для упрощения вы можете заменить справочники на текстовые поля.

** Дополнительное задание:**
- Любая функциональность, больше, чем один модуль простейшего CRUD, будет плюсом.
- Добавление данных из справочных таблиц.

В русскоязычном сообществе имеется качественный перевод [Getting Started with Rails](http://rusrails.ru/getting-started-with-rails). Этого руководства достаточно, чтобы создать CRUD. Необходимый минимум для данной лабораторной - это список объектов из базы и страница для подробного описания объекта. Далее в разделе "Порядок выполнения" приведен краткий алгоритм действий. За более подробной инструкцией обращайтесь к руководству.

## Краткие теоретические сведения

Краткое описание особенностей и синтаксиса Ruby смотрите в [Cheat list Ruby](/mesdt/course/wiki/Cheat-list-Ruby). Язык отличается простотой и лаконичностью.

Ruby on Rails - классический MVC-фреймворк для языка Ruby.

Модели Ruby on Rails реализованы на основе ORM и Active Record. Схема базы в Ruby on Rails хранится в виде миграций. **Миграции** - это особенность Active Record, позволяющая наращивать схему вашей базы данных со временем. Вместо того, чтобы записывать изменения схемы на чистом SQL, миграции позволяют использовать специальный, очень простой язык Ruby DSL для описания изменений в ваших таблицах.

Сервер Ruby использует свою собственную систему команд Rake. **Rake** - инструмент для автоматизации сборки программного кода, написанный на Ruby, подобен таким инструментам как make (установщик из исходных кодов для Linux и Unix), Ant (для Java). После установки команды rake будут доступны из консоли операционной системы.

Для получения справки вызывайте любую команду rake с ключом `-h`, например, как в команде создания приложения:

```
	rails new -h
```

Вокруг Rails сложилась большая экосистема плагинов, - подключаемых гемов (gem). Начиная с третьей версии Rails наблюдается тенденция вынесения части функционала в отдельные гемы, отчасти из-за их более быстрого развития, чем сам Rails, отчасти для облегчения фреймворка.

Некоторые гемы: 
- Devise (для аутентификации), CanCan (для авторизации),
- Inherited Resources (для упрощения создания контроллеров с стандартным CRUD-кодом),
- friendly_id (позволяет создавать человеко-понятные веб-адреса), 
- Active Admin (для создания панелей администрирования) и др.

Для установки гема используется команда

```
	gem install имя_гема
```
	
### Структура приложения
* `app/` -	Содержит контроллеры, модели, представления, хелперы, рассыльщики и ресурсы вашего приложения. 
* `bin/` -	Содержит Rails-скрипты, которые стартуют ваше приложение, может содержать другие скрипты для развертывания или запуска. 
* `config/` -	Конфигурации правил, маршрутов, базы данных приложения, и т.д.  
* `db/` -	Содержит текущую схему вашей базы данных, а также миграции базы данных. 
* `Gemfile`, `Gemfile.lock` -	Эти файлы позволяют указать, какие зависимости от гемов нужны для вашего приложения на Rails (аналог `composer.json` в php-проектах). Эти файлы используются гемом Bundler. 
* `lib/` -	Внешние модули приложения.
* `log/` - 	Файлы логов приложения.
* `public/` -	Точка входа. Единственная папка, которая доступна извне как есть. Содержит статичные файлы и скомпилированные ресурсы.
* `Rakefile` - Этот файл содержит набор команд, которые могут быть запущены в командной строке.
* `test/` -	Юнит-тесты и прочий аппарат тестирования. 
* `tmp/` -	Временные файлы (файлы кэша, pid и сессии).
* `vendor/` -	Место для кода внешних разработчиков. В типичном приложении на Rails, включает Ruby Gems и исходный код Rails.

## Порядок выполнения

### Установка инструментов (если вы не используете виртуальную машину)

1. Скачайте и установите [Ruby on Rails](http://railsinstaller.org/ru-RU). 
1. Добавьте папку установки Ruby в переменную среды `Path`.

	```
	PATH=%PATH%;C:\RailsInstaller\Ruby2.1.0\bin\
	```
1. Зайдите в `xampp\mysql\lib\`, скопируйте файл `libmysql.dll` в папку `C:\RailsInstaller\Ruby2.1.0\bin\`. 
1. Выполните команду установки гема `mysql2` (в параметре команды укажите полный путь до mysql).
	
	```
		gem install musql2 -- '--with-mysql-dir="C:\...\xampp\mysql"'
	```

1. Если появляется ошибка ssl, выполните команды

	```	
    gem sources -r https://rubygems.org/
    gem sources -a http://rubygems.org/

	```

	и попробуйте установить гем еще раз.
	
1. Все готово к созданию приложения!

### Создание приложения

Далее приведен краткий порядок действий. Подробное описание смотрите в руководстве.

1. Создайте приложение Ruby on Rails. Это делается командой (параметр `C:\my\path\to\ruby\lab\` - это имя каталога, в котором будет создано приложение).
	
	```
		rails new C:\my\path\to\ruby\lab\ -d mysql
	```
	
	Команда работает не очень быстро, потому что докачивает из интернета необходимые гемы. Перейдите в папку `C:\my\path\to\ruby\lab\`.
	
1. Посмотрите структуру приложения. Найдите файл `database.yml` (конфигурация базы данных) и `routes.rb` (конфигурация маршрутов, содержит много примеров). Сконфигурируйте базу данных. Не забудьте запустить сервер базы данных!
1. Запустите сервер Ruby командой 
	
	```
		rails server
	```
	
	По умолчанию сервер Ruby занимает порт 3000. Зайдите на `localhost:3000` и порадуйтесь, что сайт заработал. Все последующие изменения можно производить при включеном сервере, они будут подхватываться "на лету". Вам придется запустить еще одно окно консоли, чтобы не останавливать сервер.
	
1. Сгенерируйте "строительные леса" для CRUD. Чтобы уменьшить количество кода, используйте правила именования (см. руководство).
	
	```
	rails generate scaffold student name:text age:integer
	```
	
	При выполнении команды создается файл модели, файл миграции, контроллеры, представления, ресурсы и все необходимое для функционирования CRUD. Изучите их структуру.	
1. Запустите миграцию. При этом на сервере создастся база в соответствии с вашим описанием. Обратите внимание, что если на сервере что-то было, оно будет приведено в соответствие со схемой, описанной в миграции. Кроме того, Ruby on Rails сам добавит к вашим полям `id`, `created_at` и `updated_at`, и будет сам их заполнять.	
	
	```
	rake db:migrate
	```

	Если вы промазали с полями таблицы, то их можно поменять в файле миграции, который находится в папке `db/`, и снова выполнить эту команду.
	
1. Откройте созданный файл контроллера с помощью текстового редактора и изучите его содержимое.
1. Зайдите в файл конфигурации маршрутов, раскомментируйте и исправьте строчку с маршрутом до главной страницы.
	
	```
	root 'students#index'
	```

1. Обновите страницу сайта и проверьте работоспособность. Заметьте, до этого момента вам не мешало незнание Ruby.
1. Добавьте верстку из первой лабораторной в представления и готовьтесь к защите лабы.

## Порядок защиты
На защите необходимо продемонстрировать работающее приложение, реализующее CRUD одной сущности по вашему заданию. В отчете - код контроллера, миграции и представлений.

## Ссылки на скачивание инструментов
- [Установщик Ruby on Rails](http://railsinstaller.org/ru-RU)

## Дополнительная литература
- [Документация по фреймворку на русском](http://rusrails.ru/)
- [Getting Started with Rails на русском](http://rusrails.ru/getting-started-with-rails)
- [Getting Started with Rails (пример создания блога)](http://guides.rubyonrails.org/getting\_started.html)
- [Большой список гемов] `https://rubygems.org)
- [Русскоязычный Викиучебник по Ruby](http://ru.wikibooks.org/wiki/Ruby)
